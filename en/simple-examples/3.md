# Domain Expert AI Agent Document Analysis Workflow

This example demonstrates a workflow that uses a legal domain expert AI agent to analyze complex legal documents and answer questions. With document filtering and response processing features, you can obtain more accurate and structured results.

## Workflow Configuration

```yaml
version: "agentflow/v1"
kind: "WorkflowSpec"
metadata:
  name: "Domain Expert Document Analysis Workflow"
  description: "Document analysis and Q&A using legal expert AI"
  version: "0.1.0"

agents:
  - id: "lawyer_agent"
    inline:
      type: "agent"
      model: "openai/gpt-4.1-mini"
      system_prompt: |
        You are a legal expert.
        Please answer questions based on the content of the following document.
        The answer must include the referenced document.

        Provide the answer in JSON format.
        Example:
        {
          "answer": "This is the answer content.",
          "references": [
            "Document1",
            "Document2"
          ]
        }

        <Help>
          Use the document's name attribute when displaying reference documents.
        </Help>

        <document name="Genius act">
          {{{documents.genius_act.content}}}
        </document>

nodes:
  start:
    type: "agent_task"
    agent: "lawyer_agent"
    next: "end"

  end:
    type: "end"
```

## Document Filtering Settings

This workflow provides the following document filtering features:

### 1. Base64 Image Removal Filter
```javascript
import { RemoveBase64ImageFilter } from '../src/utils/document-filters';

const documents = {
  'genius_act': {
    type: 'markdown',
    filters: [new RemoveBase64ImageFilter()], // Remove Base64 encoded images
    content: readFileSync(path.resolve(__dirname, './docs/Genius act.md'), 'utf-8')
  }
};
```

### 2. Markdown JSON Response Filter
```javascript
import { RemoveMarkdownJsonFilter } from '../src/utils/response-filters';

// Apply response filter when creating workflow
const workflow = new Workflow({
  mainWorkflow: workflowYaml,
  documents,
  responseFilters: [new RemoveMarkdownJsonFilter()] // Remove markdown code blocks
});
```

## Test Configuration

### Environment Settings
```javascript
// Load environment variables
import { loadTestEnv } from './utils/env-loader';
loadTestEnv();

// Create configuration
const testConfig = createConfig({
  llmBaseUrl: `${baseUrl}/ai/v1/spaces/${spaceId}`,
  llmApiKey: process.env.SOWONAI_API_KEY,
  llmModelName: 'mistralai/mistral-small-3.2-24b-instruct:free',
  llmTemperature: 0.7,
  llmTimeout: 60000,
  llmMaxRetries: 2,
  logLevel: 'debug'
});
```

### Required Environment Variables
```bash
# SowonAI API settings
SOWONAI_BASE_URL=http://localhost:3030
SOWONAI_SPACE_ID=spc_sowonlabs
SOWONAI_API_KEY=your_api_key_here
SOWONAI_TEMPERATURE=0.7
```

## Usage Examples

### 1. Legal Document Analysis
```javascript
const result = await workflow.ask("Why did the United States propose this bill?");
```

Expected response:
```json
{
  "answer": "The United States proposed this bill to strengthen national competitiveness and promote technological innovation. The strategic purpose is to maintain global leadership in AI and advanced technology fields.",
  "references": [
    "Genius Act"
  ]
}
```

### 2. Analysis of Key Provisions
```javascript
const result = await workflow.ask("Please summarize the core provisions of this bill.");
```

### 3. Legal Impact Assessment
```javascript
const result = await workflow.ask("What impact will this bill have on technology companies?");
```

### 4. International Comparative Analysis
```javascript
const result = await workflow.ask("What are the differences compared to similar bills in other countries?");
```

## Advanced Features

### 1. Document Filter Test
```javascript
// Base64 image removal test
const filter = new RemoveBase64ImageFilter();
const result = filter.filter('Text <data:image/png;base64,iVBORw0K...> Text after');
// Result: 'Text  Text after'
```

### 2. Response Filter Test
```javascript
// Markdown JSON removal test
const filter = new RemoveMarkdownJsonFilter();
const markdown = '```json\n{"answer": "Test response", "references": ["Document1"]}\n```';
const filtered = filter.filter(markdown);
// Result: '{"answer": "Test response", "references": ["Document1"]}'
```

### 3. Test Interceptor Usage
```javascript
import { TestInterceptor } from './utils/TestInterceptor';

const interceptor = new TestInterceptor();
const workflow = new Workflow({
  mainWorkflow: workflowYaml,
  documents,
  interceptor: interceptor,
  config: testConfig
});

// After workflow execution
interceptor.printSummary(); // Print execution summary
```

## Execution Result Example

```
ðŸ“‹ Legal Document Analysis Results:

Question: "Why did the United States propose this bill?"

Answer: {
  "answer": "The United States proposed the Genius Act for the following reasons:\n\n1. **Strengthening National Competitiveness**: To maintain a leading position in global technology competition\n2. **Talent Acquisition**: To attract and nurture top-level science and technology talent\n3. **Innovation Ecosystem Construction**: To build a systematic system connecting R&D and commercialization\n4. **National Security**: To secure autonomous capabilities in core technology fields",
  "references": [
    "Genius Act"
  ]
}

ðŸ“Š Execution Statistics:
- Total execution time: 2.3 seconds
- Token usage: 1,247 tokens
- Reference documents: 1
- Filters applied: 2 (image removal, JSON formatting)
```

## Workflow Expansion

You can expand this basic structure as follows:

### 1. Multi-Document Analysis
```yaml
<document name="Related Law1">
  {{{documents.related_law1.content}}}
</document>
<document name="Related Law2">
  {{{documents.related_law2.content}}}
</document>
```

### 2. Expert Agents by Specialty
- Patent expert agent
- Regulatory analysis expert agent
- International law expert agent

### 3. Step-by-Step Analysis Workflow
```yaml
nodes:
  analyze:
    type: "agent_task"
    agent: "analyzer_agent"
    next: "review"

  review:
    type: "agent_task"
    agent: "reviewer_agent"
    next: "summarize"

  summarize:
    type: "agent_task"
    agent: "summarizer_agent"
    next: "end"
```

This workflow allows you to systematically analyze complex legal documents and obtain structured answers. By combining the knowledge of domain expert AI with document filtering features, it provides accurate and reliable analysis results.