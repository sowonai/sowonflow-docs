# 도메인 전문가 AI 에이전트를 활용한 문서 분석 워크플로우

이 예제는 법률 도메인 전문가 AI 에이전트를 활용하여 복잡한 법률 문서를 분석하고 질문에 답변하는 워크플로우를 보여줍니다. 문서 필터링과 응답 처리 기능을 통해 보다 정확하고 구조화된 결과를 얻을 수 있습니다.

## 워크플로우 구성

```yaml
version: "agentflow/v1"
kind: "WorkflowSpec"
metadata:
  name: "도메인 전문가 문서 분석 워크플로우"
  description: "법률 전문가 AI를 활용한 문서 분석 및 질의응답"
  version: "0.1.0"

agents:
  - id: "lawyer_agent"
    inline:
      type: "agent"
      model: "openai/gpt-4.1-mini"
      system_prompt: |
        당신은 법률 전문가입니다.
        아래 문서의 내용을 바탕으로 질문에 답변해주세요.
        답변에는 반드시 참조한 문서를 포함해주세요.

        JSON 형태로 답변을 제공해주세요.
        예시:
        {
          "answer": "답변 내용입니다.",
          "references": [
            "문서1",
            "문서2"
          ] 
        }
        
        <도움말>  
          참조 문서를 표시할 때는 문서의 name 속성을 사용하세요.
        </도움말>

        <document name="Genius act">
          {{{documents.genius_act.content}}}
        </document>

nodes:
  start:
    type: "agent_task"
    agent: "lawyer_agent"
    next: "end"
  
  end:
    type: "end"
```

## 문서 필터링 설정

이 워크플로우는 다음과 같은 문서 필터링 기능을 제공합니다:

### 1. Base64 이미지 제거 필터
```javascript
import { RemoveBase64ImageFilter } from '../src/utils/document-filters';

const documents = {
  'genius_act': {
    type: 'markdown',
    filters: [new RemoveBase64ImageFilter()], // Base64 인코딩된 이미지 제거
    content: readFileSync(path.resolve(__dirname, './docs/Genius act.md'), 'utf-8')
  }
};
```

### 2. 마크다운 JSON 응답 필터
```javascript
import { RemoveMarkdownJsonFilter } from '../src/utils/response-filters';

// 워크플로우 생성 시 응답 필터 적용
const workflow = new Workflow({
  mainWorkflow: workflowYaml,
  documents,
  responseFilters: [new RemoveMarkdownJsonFilter()] // 마크다운 코드 블록 제거
});
```

## 테스트 구성

### 환경 설정
```javascript
// 환경 변수 로드
import { loadTestEnv } from './utils/env-loader';
loadTestEnv();

// 설정 생성
const testConfig = createConfig({
  llmBaseUrl: `${baseUrl}/ai/v1/spaces/${spaceId}`,
  llmApiKey: process.env.SOWONAI_API_KEY,
  llmModelName: 'mistralai/mistral-small-3.2-24b-instruct:free',
  llmTemperature: 0.7,
  llmTimeout: 60000,
  llmMaxRetries: 2,
  logLevel: 'debug'
});
```

### 필수 환경 변수
```bash
# SowonAI API 설정
SOWONAI_BASE_URL=http://localhost:3030
SOWONAI_SPACE_ID=spc_sowonlabs
SOWONAI_API_KEY=your_api_key_here
SOWONAI_TEMPERATURE=0.7
```

## 사용 예시

### 1. 법률 문서 분석
```javascript
const result = await workflow.ask("미국이 왜 이 법안을 발의했을까?");
```

예상 응답:
```json
{
  "answer": "미국은 국가 경쟁력 강화와 기술 혁신을 위해 이 법안을 발의했습니다. 특히 AI 및 첨단 기술 분야에서의 글로벌 리더십을 유지하기 위한 전략적 목적이 있습니다.",
  "references": [
    "천재법안"
  ]
}
```

### 2. 법안의 주요 조항 분석
```javascript
const result = await workflow.ask("이 법안의 핵심 조항들을 요약해주세요.");
```

### 3. 법적 영향 평가
```javascript
const result = await workflow.ask("이 법안이 기술 기업들에게 미칠 영향은 무엇인가요?");
```

### 4. 국제적 비교 분석
```javascript
const result = await workflow.ask("다른 국가들의 유사한 법안과 비교했을 때 어떤 차이점이 있나요?");
```

## 고급 기능

### 1. 문서 필터 테스트
```javascript
// Base64 이미지 제거 테스트
const filter = new RemoveBase64ImageFilter();
const result = filter.filter('텍스트 <data:image/png;base64,iVBORw0K...> 뒤의 텍스트');
// 결과: '텍스트  뒤의 텍스트'
```

### 2. 응답 필터 테스트
```javascript
// 마크다운 JSON 제거 테스트
const filter = new RemoveMarkdownJsonFilter();
const markdown = '```json\n{"answer": "테스트 응답", "references": ["문서1"]}\n```';
const filtered = filter.filter(markdown);
// 결과: '{"answer": "테스트 응답", "references": ["문서1"]}'
```

### 3. 테스트 인터셉터 활용
```javascript
import { TestInterceptor } from './utils/TestInterceptor';

const interceptor = new TestInterceptor();
const workflow = new Workflow({
  mainWorkflow: workflowYaml,
  documents,
  interceptor: interceptor,
  config: testConfig
});

// 워크플로우 실행 후
interceptor.printSummary(); // 실행 요약 출력
```

## 실행 결과 예시

```
📋 법률 문서 분석 결과:

질문: "미국이 왜 이 법안을 발의했을까?"

답변: {
  "answer": "미국은 다음과 같은 이유로 천재법안을 발의했습니다:\n\n1. **국가 경쟁력 강화**: 글로벌 기술 경쟁에서 우위를 유지하기 위해\n2. **인재 확보**: 최고 수준의 과학기술 인재를 유치하고 육성하기 위해\n3. **혁신 생태계 구축**: 연구개발과 상용화를 연결하는 체계적인 시스템 구축\n4. **국가 안보**: 핵심 기술 분야에서의 자주적 역량 확보",
  "references": [
    "천재법안"
  ]
}

📊 실행 통계:
- 총 실행 시간: 2.3초
- 토큰 사용량: 1,247 토큰
- 참조 문서: 1개
- 필터 적용: 2개 (이미지 제거, JSON 정리)
```

## 워크플로우 확장

이 기본 구조를 바탕으로 다음과 같이 확장할 수 있습니다:

### 1. 다중 문서 분석
```yaml
<document name="관련법안1">
  {{{documents.related_law1.content}}}
</document>
<document name="관련법안2">
  {{{documents.related_law2.content}}}
</document>
```

### 2. 전문 분야별 에이전트
- 특허 전문가 에이전트
- 규제 분석 전문가 에이전트
- 국제법 전문가 에이전트

### 3. 단계별 분석 워크플로우
```yaml
nodes:
  analyze:
    type: "agent_task"
    agent: "analyzer_agent"
    next: "review"
  
  review:
    type: "agent_task"
    agent: "reviewer_agent"
    next: "summarize"
    
  summarize:
    type: "agent_task"
    agent: "summarizer_agent"
    next: "end"
```

이 워크플로우를 통해 복잡한 법률 문서를 체계적으로 분석하고, 구조화된 답변을 얻을 수 있습니다. 도메인 전문가 AI의 지식과 문서 필터링 기능을 결합하여 정확하고 신뢰할 수 있는 분석 결과를 제공합니다.
